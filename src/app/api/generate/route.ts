import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { checkAndIncrementUsage } from '@/lib/usage';

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

// 다양한 글 구조 템플릿 (SEO 최적화를 위해 랜덤 선택)
const ARTICLE_STRUCTURES = [
  {
    name: '경험-사례형',
    structure: `## 글 구조 (경험-사례형) - 체류시간 + 전환 최적화
목표: 단일 키워드 상위가 아닌, 본문 전체에서 분산 유입 + 체류 + 전환

1. 상황 훅 (경험/사례로 시작)
- "요즘 OOO 때문에 상담이 이렇게 들어오더라"
- "OOO 검색하고 왔는데, 실제로는 여기서 많이들 틀려요"
- 실제 현장감 있는 에피소드로 시작

2. 검색자 의도 확정 (진짜 원하는 것)
- "결국 사람들이 원하는 건 'OOO가 되냐'가 아니라 '내 상황에 안전하냐'"
- 표면적 질문 뒤에 숨은 진짜 고민 짚어주기

3. 변수 맵 (케이스가 갈리는 이유 3~5개)
- 얼굴 조건, 생활패턴, 예산, 통증, 유지력, 시술 방식 등
- 여기서 연관 키워드가 자연스럽게 분산 배치됨

4. 판단 체크리스트 (선택 기준)
- "딱 4가지만 체크하면 실패 확률 확 떨어짐"
- "이 질문에 답 못하면 그 샵은 패스"
- 독자가 스스로 판단할 수 있는 기준 제시

5. 선 긋기 + 예외 인정 (안전장치)
- "이런 분은 지금 말고, 이런 방식이 더 맞다"
- "단, OOO한 경우는 달라질 수 있다"
- 무조건적 권유가 아닌 신뢰감 형성

6. 다음 행동 제시 (질문 + CTA)
- 질문으로 끝내되 다음 행동을 자연스럽게 연결
- "내 케이스가 어디에 해당하는지 모르겠다면..."`,
  },
  {
    name: '질문-답변형',
    structure: `## 글 구조 (질문-답변형)
독자가 실제로 검색창에 칠 법한 구체적인 질문 하나를 던지고, 그 질문에 깊이 있게 답하는 형태.
- 도입: "이런 상황에서 이걸 궁금해하더라" 현장감 있는 질문 제시
- 전개: 그 질문이 나오게 된 맥락과 배경 (뻔한 상식 나열 금지, 구체적 상황 묘사)
- 핵심: 다른 글에서는 못 본 실질적인 답변. "전문성이 중요합니다" 같은 당연한 말 금지. 구체적인 판단 기준, 숫자, 원리를 제시
- 심화: "여기서 한 발 더" - 관련된 의외의 사실이나 현장에서만 알 수 있는 디테일
- 마무리: 독자가 바로 행동할 수 있는 구체적 기준 제시`,
  },
  {
    name: '오해-진실형',
    structure: `## 글 구조 (오해-진실형)
이 시술/주제에 대해 구체적으로 잘못 알려진 정보 하나를 콕 집어서 바로잡는 형태.
- 도입: 실제로 많이 퍼져있는 구체적인 오해 하나를 정확하게 언급 (뭉뚱그린 오해 금지)
- 문제제기: 왜 이 오해가 생겼는지, 어디서 잘못 전해졌는지 현실적인 배경
- 진실: 실제 원리나 메커니즘 기반으로 왜 다른지 설명. "위생이 중요합니다" 같은 뻔한 결론 금지
- 근거: 기술적/과학적 이유, 현장 경험에서 나온 구체적 근거
- 마무리: "이걸 알면 이렇게 달라진다" - 실제 판단에 도움되는 관점`,
  },
  {
    name: '비교-분석형',
    structure: `## 글 구조 (비교-분석형)
이 시술/주제 안에서 구체적인 두세 가지 선택지를 깊이 있게 비교하는 형태.
- 도입: "이거랑 저거 뭐가 다른 거야?" 실제 고민 상황
- 비교: 각 옵션의 원리적 차이를 구체적으로 설명 (기법, 재료, 과정의 실제 차이)
- 핵심: 겉보기엔 비슷하지만 결과가 달라지는 핵심 포인트 (뻔한 장단점 표 금지)
- 기준: "당신이 OO라면 이쪽, OO라면 저쪽" 구체적 조건별 추천
- 마무리: 선택 전 스스로에게 물어봐야 할 질문 제시`,
  },
  {
    name: '상황별-가이드형',
    structure: `## 글 구조 (상황별-가이드형)
같은 시술이라도 상황에 따라 완전히 달라지는 구체적인 케이스를 보여주는 형태.
- 도입: "똑같은 시술인데 왜 결과가 이렇게 다를까?" 의문 제기
- 케이스A: 구체적인 조건(피부타입, 나이, 생활패턴 등)에 따른 실제 차이점
- 케이스B: 전혀 다른 조건에서의 실제 차이점
- 핵심: 이 차이를 만드는 진짜 이유 (원리, 메커니즘 기반 설명)
- 마무리: 자기 케이스를 파악하는 구체적 방법 안내`,
  },
  {
    name: '통찰-관점형',
    structure: `## 글 구조 (통찰-관점형)
업계 안에서만 알 수 있는 시각으로, 독자가 미처 생각 못한 관점을 제시하는 형태.
- 도입: 독자가 당연하다고 생각하는 것 하나를 뒤집기
- 관점 전환: "사실은 이게 더 중요한데 아무도 안 알려줌" 형태의 인사이트
- 근거: 왜 그런지 현장 경험이나 기술적 근거로 뒷받침 ("전문성이 중요합니다" 같은 뻔한 말 금지)
- 적용: 이 관점을 알면 어떻게 다르게 판단할 수 있는지
- 마무리: 생각해볼 질문 던지기`,
  },
  {
    name: '현장-디테일형',
    structure: `## 글 구조 (현장-디테일형)
실제 시술 현장에서만 알 수 있는 구체적인 디테일을 풀어내는 형태.
- 도입: 시술/관리의 실제 과정에서 사람들이 모르는 한 장면
- 과정: 실제로 어떤 순서로, 어떤 이유로 이렇게 하는지 (교과서적 설명 금지, 현장 디테일 위주)
- 숨은 디테일: 같은 시술이라도 결과를 바꾸는 사소하지만 중요한 포인트
- 의미: 이게 왜 최종 결과에 영향을 미치는지
- 마무리: 이걸 알고 보면 달라지는 눈`,
  },
];

// 랜덤 글 구조 선택 함수
function getRandomArticleStructure(): string {
  const randomIndex = Math.floor(Math.random() * ARTICLE_STRUCTURES.length);
  const selected = ARTICLE_STRUCTURES[randomIndex];
  return selected.structure;
}

// 주요 시/구 이름 목록 (큰 키워드 판단용)
const LARGE_REGIONS = [
  // 특별시/광역시
  '서울', '부산', '대구', '인천', '광주', '대전', '울산', '세종',
  // 경기도 시
  '수원', '성남', '고양', '용인', '부천', '안산', '안양', '남양주', '화성', '평택', '의정부', '시흥', '파주', '김포', '광명', '광주', '군포', '하남', '오산', '이천', '안성', '의왕', '양주', '포천', '여주', '동두천', '과천', '구리', '양평',
  // 서울 구
  '강남', '서초', '송파', '강동', '마포', '용산', '성동', '광진', '동대문', '중랑', '성북', '강북', '도봉', '노원', '은평', '서대문', '종로', '중구', '영등포', '동작', '관악', '금천', '구로', '양천', '강서',
  // 기타 주요 도시
  '천안', '청주', '전주', '포항', '창원', '김해', '제주', '춘천', '원주', '강릉', '목포', '순천', '여수', '군산', '익산', '경주', '구미', '안동', '진주', '통영', '거제', '양산',
];

// 키워드 크기 판단 함수 (시/구 단위 = 큰 키워드)
function isLargeKeyword(keyword: string): boolean {
  // 키워드에 시/구 이름이 포함되어 있고, "동"으로 끝나지 않으면 큰 키워드
  const hasLargeRegion = LARGE_REGIONS.some(region => keyword.includes(region));
  const endsWithDong = /동(?:눈썹|피부|네일|헤어|메이크업|왁싱|속눈썹|두피|탈모|반영구|문신|시술|관리|샵|아트|펌|연장)/.test(keyword) || keyword.match(/[가-힣]+동[가-힣]*$/);

  // 큰 지역 이름이 있고, 동으로 끝나지 않으면 큰 키워드
  if (hasLargeRegion && !endsWithDong) {
    return true;
  }

  // "시" 또는 "구"로 끝나는 패턴 체크
  if (/[가-힣]+(시|구)[가-힣]*/.test(keyword) && !endsWithDong) {
    return true;
  }

  return false;
}

const SEO_BASE_PROMPT = `당신은 뷰티 업계 10년차 현장 전문가처럼 블로그 글을 쓰는 시스템입니다.

## 🎯 핵심 원칙: "이 글에서만 얻을 수 있는 정보"를 써라

당신이 써야 하는 글은 이런 글입니다:
- 이 시술/주제의 구체적인 원리, 메커니즘, 과학적 배경을 다루는 글
- 현장에서 직접 겪어봐야 알 수 있는 디테일이 담긴 글
- 독자가 "아 이건 여기서 처음 알았다"고 느끼는 글
- 하나의 주제를 깊게 파고드는 글 (여러 주제를 얕게 훑는 글 아님)

당신이 쓰면 안 되는 글은 이런 글입니다:
- 어떤 시술 글에나 복붙할 수 있는 일반론
- 여러 항목을 순서대로 나열하는 체크리스트형 글
- 같은 말을 표현만 바꿔서 반복하는 글

## 🚫 사용 금지 단어/표현 (이 단어들이 본문에 등장하면 글이 거부됩니다)
저는, 제가, 저희, 나는, 내가, 우리 샵, 저희 샵, 예약하세요, 문의주세요, 상담받으세요, 방문해보세요, 찾아와주세요, 지금 바로, 서두르세요, 만족하셨습니다, 결과가 좋았습니다, 후기가 좋습니다, 첫째, 둘째, 셋째, 첫 번째, 두 번째, 세 번째

## 🚫 사용 금지 문장 패턴 (이 패턴이 등장하면 글이 거부됩니다)
- "~이/가 중요합니다" 패턴 반복 (한 글에 2회 이상 사용 금지)
- "~을/를 확인해야 합니다" 패턴 반복 (한 글에 2회 이상 사용 금지)
- "~을/를 고려해야 합니다" 패턴 반복 (한 글에 2회 이상 사용 금지)
- 한 문단에서 다루는 주제가 끝나면, 다음 문단에서 완전히 다른 각도의 이야기를 해야 합니다
- 같은 결론("그래서 잘 골라야 한다", "그래서 확인해봐야 한다")으로 끝나는 문단이 2개 이상 있으면 안 됩니다

## ✅ 글쓰기 방식

글의 관점: 정보 전달자/안내자 (시술자 관점 아님, 3자 관점)

문장 스타일:
- 한 문장 20~30자로 짧게 끊기
- "관찰해보면...", "살펴보면...", "많은 분들이 ~하지만 실제로는..." 패턴 활용
- 가상 인물 스토리 금지 ("30대 직장인 김민지 씨는..." 이런 거 금지)

글의 흐름:
- 하나의 핵심 주장이나 관점을 정하고, 그것을 깊이 파고들기
- 문단마다 새로운 정보나 관점을 추가하기 (같은 말 반복 금지)
- 마무리는 질문 던지기 또는 생각거리 제시 (영업 멘트 금지)

## 형식 규칙
- 한국어만 사용 (영어 등 다른 언어 금지)
- 마크다운(##, **, ---, 리스트 기호) 금지, 순수 텍스트만
- 제목에 핵심 키워드 포함
- 특정 단어 10회 이상 반복 금지
- 존댓말(~합니다, ~입니다) 사용
- 공백 제외 최소 1,500자 이상

## 키워드 배치 (매우 중요)
핵심 키워드를 본문에 정확히 3~5회만 포함 (절대 6회 이상 사용 금지):
- 본문 시작 첫 2~3문장 이내 1회
- 본문 중간 부분 1~2회
- 본문 마지막 2~3문장 이내 1회
- 키워드를 과도하게 반복하면 네이버에서 저품질 처리되므로 최대 5회를 넘기지 마세요
- 키워드 대신 동의어, 유사 표현, 줄임말 등으로 자연스럽게 대체하세요`;

// 일반 업종용 브랜딩 프롬프트 (1인칭 허용)
const BRANDING_GENERAL_PROMPT = `당신은 뷰티 샵의 브랜딩 글을 작성하는 전문 시스템입니다.

## 브랜딩 글 특성
브랜딩 글(자기소개, 철학, 샵 스토리)은 샵 운영자가 직접 자신의 이야기를 전하는 글입니다.

## ✅ 글쓰기 스타일
- 1인칭("저는", "제가") 자연스럽게 사용 가능
- 스토리와 정보가 자연스럽게 어우러지는 글
- 진솔하고 따뜻한 톤으로 자신의 이야기 전달
- 독자가 읽으면서 공감하고 신뢰가 쌓이는 글

## ⚠️ 금지 표현

### 어색한 3인칭 표현 금지:
- "이 샵의 원장은", "이 샵에서는" 금지 (자기소개인데 어색함)
- "이곳"이라는 표현 금지 (딱딱함)

### 영업/유도 표현 금지:
- "예약하세요", "문의주세요", "상담받으세요" 금지
- "방문해보세요", "찾아와주세요" 금지
- "지금 바로", "서두르세요" 금지

### 과대광고 금지:
- "최고의", "1등", "완벽한" 등 금지
- "결과 보장", "효과 확실" 등 금지

### 뻔한 AI 문체 금지:
- "저는 10년 경력의 전문가입니다" 같은 딱딱한 자기소개 금지
- "고객님의 아름다움을 위해 최선을 다하겠습니다" 같은 뻔한 멘트 금지

## ⚠️ 필수: 글자수 규칙 (가장 중요)
- 공백 제외 최소 1,500자 이상 반드시 작성
- 1,500자 미만이면 글이 거부됩니다
- 각 섹션을 충분히 상세하게 작성하세요
- 짧은 글은 절대 금지

## 형식 규칙
- 마크다운(##, **, ---, 리스트) 절대 금지
- 순수 텍스트로만 작성
- 제목에 핵심 키워드 포함`;

// 규제 업종(반영구)용 브랜딩 프롬프트 (자기 홍보 금지, 정보 중심)
const BRANDING_REGULATED_PROMPT = `당신은 뷰티 업계 10년차 현장 전문가처럼 블로그 글을 쓰는 시스템입니다.
이 업종은 규제 업종(반영구/눈썹문신)이므로 정보 전달 목적으로만 작성합니다.

## 🎯 핵심 원칙: "이 글에서만 얻을 수 있는 정보"를 써라

당신이 써야 하는 글은 이런 글입니다:
- 이 시술/기법의 구체적인 원리, 메커니즘, 과학적 배경을 깊이 다루는 글
- 현장에서 직접 겪어봐야 알 수 있는 디테일이 담긴 글
- 독자가 "아 이건 여기서 처음 알았다"고 느끼는 글
- 하나의 핵심 주장이나 관점을 정하고 깊이 파고드는 글

당신이 쓰면 안 되는 글은 이런 글입니다:
- 어떤 시술 글에나 복붙할 수 있는 일반론
- 여러 항목을 순서대로 나열하는 체크리스트형 글
- 같은 말을 표현만 바꿔서 반복하는 글

## 🚫 사용 금지 단어/표현 (등장 시 글 거부)
저는, 제가, 저희, 나는, 내가, 우리 샵, 저희 샵, 이 샵, 이곳, 예약하세요, 문의주세요, 상담받으세요, 방문해보세요, 찾아와주세요, 만족하셨습니다, 결과가 좋았습니다, 후기가 좋습니다, 감탄사를 연발, 칭찬을 받는다, 숙련된 전문가의 손길, 최상의 서비스, 첫째, 둘째, 셋째, 첫 번째, 두 번째

## 🚫 사용 금지 문장 패턴 (등장 시 글 거부)
- "~이/가 중요합니다" 패턴 반복 (한 글에 2회 이상 사용 금지)
- "~을/를 확인해야 합니다" 패턴 반복 (한 글에 2회 이상 사용 금지)
- "~을/를 고려해야 합니다" 패턴 반복 (한 글에 2회 이상 사용 금지)
- 같은 결론으로 끝나는 문단이 2개 이상 있으면 안 됩니다

## ✅ 글쓰기 방식

글의 관점: 정보 전달자 (특정 샵/시술자 언급 없이, 업계 전반의 지식 공유)

문장 스타일:
- 한 문장 20~30자로 짧게 끊기
- "관찰해보면...", "살펴보면...", "많은 분들이 ~하지만 실제로는..." 패턴 활용
- 가상 인물 스토리 금지

글의 흐름:
- 하나의 핵심 주장이나 관점을 정하고, 그것을 깊이 파고들기
- 문단마다 새로운 정보나 관점을 추가하기 (같은 말 반복 금지)
- 마무리는 질문 던지기 또는 생각거리 제시

## 형식 규칙
- 한국어만 사용
- 마크다운(##, **, ---, 리스트 기호, 별표 강조) 금지, 순수 텍스트만
- 제목에 핵심 키워드 포함
- 특정 단어 10회 이상 반복 금지
- 존댓말 사용
- 공백 제외 최소 1,500자 이상

## 키워드 배치 (매우 중요)
핵심 키워드를 본문에 정확히 3~5회만 포함 (절대 6회 이상 사용 금지):
- 본문 시작 첫 2~3문장 이내 1회
- 본문 중간 부분 1~2회
- 본문 마지막 2~3문장 이내 1회
- 키워드를 과도하게 반복하면 네이버에서 저품질 처리되므로 최대 5회를 넘기지 마세요
- 키워드 대신 동의어, 유사 표현, 줄임말 등으로 자연스럽게 대체하세요`;

const BRANDING_TYPE_NAMES: Record<string, string> = {
  intro: '자기소개',
  philosophy: '철학/신념',
};

export async function POST(request: NextRequest) {
  if (!GEMINI_API_KEY) {
    return NextResponse.json({ error: 'API 키가 설정되지 않았습니다.' }, { status: 500 });
  }

  // 인증 확인
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return NextResponse.json({ error: '로그인이 필요합니다.' }, { status: 401 });
  }

  // 사용량 체크
  const usage = await checkAndIncrementUsage(user.id);
  if (!usage.allowed) {
    return NextResponse.json(
      { error: '오늘의 무료 생성 횟수(3회)를 모두 사용했습니다.', remaining: 0 },
      { status: 403 },
    );
  }

  try {
    const {
      keyword,
      businessCategory,
      topic,
      purpose,
      readerState,
      selectedTitle,
      contentType = 'seo',
      brandingType,
      brandingInfo,
      treatmentInfo,
    } = await request.json();

    // 규제 업종 여부 확인
    const isRegulatedBusiness = businessCategory === 'semi-permanent' || businessCategory === '반영구';

    let systemPrompt: string;
    let userPrompt: string;

    if (contentType === 'branding') {
      // 브랜딩 글 생성 - 규제 업종(반영구)은 1인칭 금지, 나머지는 1인칭 허용
      systemPrompt = isRegulatedBusiness ? BRANDING_REGULATED_PROMPT : BRANDING_GENERAL_PROMPT;
      const brandingTypeName = BRANDING_TYPE_NAMES[brandingType] || '브랜딩';

      // 구조화된 브랜딩 정보를 상세 텍스트로 변환
      let detailedInfo = '';
      if (brandingInfo && brandingType) {
        const info = brandingInfo[brandingType];
        if (brandingType === 'intro' && info) {
          const { experience, specialty, startReason, customerMind } = info;
          detailedInfo = `
## 원장님 정보 (이 정보를 바탕으로 글을 작성하세요)
- 경력: ${experience || '미입력'}
- 전문 분야: ${specialty || '미입력'}
- 이 일을 시작한 계기: ${startReason || '미입력'}
- 고객을 대하는 마음: ${customerMind || '미입력'}`;
        } else if (brandingType === 'philosophy' && info) {
          const { coreValue, difference, whyPhilosophy, message } = info;
          detailedInfo = `
## 샵의 철학/신념 (이 정보를 바탕으로 글을 작성하세요)
- 가장 중요한 가치: ${coreValue || '미입력'}
- 다른 샵과 다른 점: ${difference || '미입력'}
- 그런 철학을 갖게 된 이유: ${whyPhilosophy || '미입력'}
- 고객에게 전하고 싶은 메시지: ${message || '미입력'}`;
        }
      }

      userPrompt = `다음 조건에 맞는 뷰티 브랜딩 블로그 글을 작성해주세요.

키워드: ${keyword}
업종: ${businessCategory}
브랜딩 종류: ${brandingTypeName}
${selectedTitle ? `제목: ${selectedTitle}` : ''}
${detailedInfo}

## 브랜딩 종류별 글 구조

${brandingType === 'intro' ? (isRegulatedBusiness ? `
### 정보성 글 구조 (규제 업종):
⚠️ 자기소개가 아닌, 업계 정보 전달 글로 작성하세요.
1. 눈썹문신/반영구를 처음 고민하는 사람들이 궁금해하는 점으로 시작
2. 좋은 시술자를 고르는 기준 (경력, 전문성 등 일반론)
3. 시술 전 확인해야 할 사항들
4. 마무리: 충분히 알아보고 신중하게 결정하라는 조언
- 절대 금지: 특정 샵/시술자 언급, 자기 홍보, 고객 만족 언급
` : `
### 자기소개 글 구조:
1. 이 일을 시작하게 된 계기나 배경으로 시작 (위 정보의 "이 일을 시작한 계기" 활용)
2. 경력과 전문 분야 소개 (위 정보의 "경력", "전문 분야" 활용)
3. 어떤 마음으로 고객을 대하는지 (위 정보의 "고객을 대하는 마음" 활용)
4. 앞으로의 다짐이나 메시지로 마무리
- 1인칭("저는", "제가") 자연스럽게 사용하여 진솔한 자기소개 작성
- 입력된 정보를 자연스럽게 문장으로 풀어서 작성
`) : ''}

${brandingType === 'philosophy' ? (isRegulatedBusiness ? `
### 정보성 글 구조 (규제 업종):
⚠️ 샵 철학이 아닌, 업계 정보 전달 글로 작성하세요.
1. 눈썹문신/반영구 업계의 일반적인 현상이나 트렌드
2. 시술 선택 시 중요하게 봐야 할 가치들 (일반론)
3. 좋은 시술의 조건, 피해야 할 것들
4. 시술 후 관리의 중요성
5. 마무리: 신중한 선택을 위한 조언
- 절대 금지: 특정 샵/시술자 언급, 자기 홍보, 고객 만족 언급
` : `
### 철학/신념 글 구조:
1. 업계의 일반적인 현상이나 트렌드 언급
2. 이 샵이 다르게 생각하는 점 (위 정보의 "다른 샵과 다른 점" 활용)
3. 왜 그런 철학을 갖게 되었는지 (위 정보의 "그런 철학을 갖게 된 이유" 활용)
4. 가장 중요하게 생각하는 가치 (위 정보의 "가장 중요한 가치" 활용)
5. 마무리 메시지 (위 정보의 "고객에게 전하고 싶은 메시지" 활용)
- 1인칭("저는", "제가") 사용하여 자신의 철학을 진솔하게 전달
- 입력된 정보를 자연스럽게 문장으로 풀어서 작성
`) : ''}

⚠️ 중요 규칙:
${isRegulatedBusiness ? `
## 규제 업종 필수 준수사항 (반영구/눈썹문신)
- 자기 홍보 절대 금지: "이 샵이 시술 잘한다", "고객이 만족한다", "추천으로 방문한다" 등 금지
- 1인칭 금지: "저는", "제가", "저희" 사용 금지
- 특정 샵 언급 금지: "이 샵에서는", "이 샵의 원장은" 금지
- 결과/후기 언급 금지: "감탄사를 연발", "자연스럽다는 칭찬" 금지
- 대신: 업종에 대한 일반적인 정보, 좋은 샵 고르는 기준, 시술 전 알아야 할 것 등 정보 전달 중심으로 작성` : `- 1인칭("저는", "제가") 자연스럽게 사용 가능`}
- "예약하세요", "상담받으세요" 등 영업 표현 금지
- 진정성 있고 따뜻한 톤으로 작성
- 위에 제공된 정보를 최대한 활용하여 구체적이고 개성 있는 글 작성

${selectedTitle ? `제목은 "${selectedTitle}"을 그대로 사용하세요.` : '제목을 첫 줄에 쓰고,'} 한 줄 띄운 후 본문을 작성해주세요.

⚠️ 키워드 "${keyword}" 배치 (정확히 3~5회만, 6회 이상 절대 금지):
- 본문 시작 부분 (첫 2~3문장 이내) 1회
- 본문 중간 부분 1~2회
- 본문 마지막 부분 (끝 2~3문장 이내) 1회
- 나머지는 동의어나 유사 표현으로 대체

⚠️ 마크다운 절대 금지:
- ##, **, ***, ---, 리스트 기호(-, *, 1. 2. 3.) 등 모든 마크다운 문법 사용 금지
- **단어** 이런 식으로 별표로 감싸는 강조 절대 금지
- 순수 텍스트로만 작성하세요

⚠️⚠️⚠️ 중요: 글자수 (필수)
- 공백 제외 최소 1,500자 이상 반드시 작성
- 1,500자 미만이면 글이 거부됩니다
- 각 단락을 충분히 상세하게, 구체적인 예시와 설명을 포함하여 작성하세요
- 짧게 끝내지 말고 독자가 충분한 정보를 얻을 수 있도록 깊이 있게 작성하세요`;

    } else {
      // SEO 글 생성 - 랜덤 글 구조 적용
      const randomStructure = getRandomArticleStructure();
      systemPrompt = `${SEO_BASE_PROMPT}

${randomStructure}`;

      userPrompt = `다음 조건에 맞는 뷰티 정보 블로그 글을 작성해주세요.

키워드: ${keyword}
업종: ${businessCategory}
글 주제: ${topic}
글의 목적: ${purpose}
독자 상태: ${readerState}
${selectedTitle ? `제목: ${selectedTitle}` : ''}
${treatmentInfo ? `
## 우리 샵만의 특별한 시술/프로그램 정보
아래 시술/프로그램 정보를 블로그 글에 자연스럽게 녹여서 작성해주세요.
단, 노골적인 홍보가 아닌, 정보 전달 형태로 언급해주세요.
예를 들어 "이런 프로그램도 있다", "이런 방식으로 관리하는 곳도 있다" 형태로 작성.

시술/프로그램 설명: ${treatmentInfo}
` : ''}

${isRegulatedBusiness ? `
⚠️ 이 글은 "반영구" 업종입니다:
- 1인칭(저는, 제가, 저희) 사용 금지. 정보 전달자 관점으로만 작성
- "눈썹", "문신", "반영구" 각 단어 10회 이하로만 사용 (동의어 활용: 브로우, 시술, 아트 등)
- 이 시술/기법만의 구체적인 원리와 메커니즘을 깊이 있게 다뤄주세요
- 여러 항목을 나열하지 말고, 하나의 관점을 깊이 파고드세요
` : ''}

위 조건을 반영하여, 시스템 규칙을 준수하는 블로그 글을 작성해주세요.
${selectedTitle ? `제목은 "${selectedTitle}"을 그대로 사용하세요.` : '제목을 첫 줄에 쓰고,'} 한 줄 띄운 후 본문을 작성해주세요.

${isLargeKeyword(keyword) ? `
⚠️ 키워드 "${keyword}" 배치 필수 (큰 지역 키워드):
- 본문에 "${keyword}"를 정확히 5~7회만 언급해주세요 (8회 이상 절대 금지)
- 시작 부분, 중간 부분(2~3회), 마지막 부분에 골고루 분산 배치
- 키워드를 과도하게 반복하면 네이버에서 저품질 처리됩니다
- 나머지는 동의어나 유사 표현으로 자연스럽게 대체하세요

마크다운 문법(##, **, ---, 리스트 기호 등)을 절대 사용하지 마세요. 순수 텍스트로만 작성하세요.

⚠️⚠️⚠️ 중요: 글자수 (필수)
- 공백 제외 최소 2,000자 이상 반드시 작성
- 2,000자 미만이면 글이 거부됩니다
- 각 단락을 충분히 상세하게, 구체적인 예시와 설명을 포함하여 작성하세요` : `
⚠️ 키워드 "${keyword}" 배치 (정확히 3~5회만, 6회 이상 절대 금지):
- 본문 시작 부분 (첫 2~3문장 이내) 1회
- 본문 중간 부분 1~2회
- 본문 마지막 부분 (끝 2~3문장 이내) 1회
- 나머지는 동의어나 유사 표현으로 대체

마크다운 문법(##, **, ---, 리스트 기호 등)을 절대 사용하지 마세요. 순수 텍스트로만 작성하세요.

⚠️⚠️⚠️ 중요: 글자수 (필수)
- 공백 제외 최소 1,500자 이상 반드시 작성
- 1,500자 미만이면 글이 거부됩니다
- 각 단락을 충분히 상세하게, 구체적인 예시와 설명을 포함하여 작성하세요`}`;
    }

    const response = await fetch(GEMINI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system_instruction: {
          parts: [{ text: systemPrompt }],
        },
        contents: [
          {
            role: 'user',
            parts: [{ text: userPrompt }],
          },
        ],
        generationConfig: {
          temperature: 1.0,
          maxOutputTokens: 4096,
        },
      }),
    });

    if (!response.ok) {
      const errorData = await response.text();
      console.error('Gemini API error:', errorData);

      if (response.status === 429) {
        return NextResponse.json(
          { error: 'API 사용량 한도를 초과했습니다. 잠시 후 다시 시도해주세요.' },
          { status: 429 },
        );
      }

      return NextResponse.json({ error: 'AI 생성에 실패했습니다.' }, { status: 500 });
    }

    const data = await response.json();
    const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

    if (!generatedText) {
      return NextResponse.json({ error: '생성된 텍스트가 없습니다.' }, { status: 500 });
    }

    return NextResponse.json({ content: generatedText });
  } catch (error) {
    console.error('Generate error:', error);
    return NextResponse.json({ error: '서버 오류가 발생했습니다.' }, { status: 500 });
  }
}
